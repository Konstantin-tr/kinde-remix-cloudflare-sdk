import{createKindeServerClient as e,GrantType as t,Configuration as r,UsersApi as s,OAuthApi as n,SubscribersApi as o,OrganizationsApi as a,ConnectedAppsApi as i,FeatureFlagsApi as c,EnvironmentsApi as l,PermissionsApi as u,RolesApi as g,BusinessApi as d,IndustriesApi as p,TimezonesApi as y,ApplicationsApi as w,CallbacksApi as m,APIsApi as S}from"@kinde-oss/kinde-typescript-sdk";import{createCookieSessionStorage as _,redirect as h}from"@remix-run/node";import{jwtDecode as I}from"jwt-decode";const k={clientId:process.env.KINDE_CLIENT_ID,clientSecret:process.env.KINDE_CLIENT_SECRET,issuerUrl:process.env.KINDE_ISSUER_URL,siteUrl:process.env.KINDE_SITE_URL,postLogoutRedirectUrl:process.env.KINDE_POST_LOGOUT_REDIRECT_URL,postLoginRedirectUrl:process.env.KINDE_POST_LOGIN_REDIRECT_URL,audience:process.env.KINDE_AUDIENCE,cookieMaxAge:process.env.KINDE_COOKIE_MAX_AGE},A=e(t.AUTHORIZATION_CODE,{authDomain:k.issuerUrl,clientId:k.clientId,clientSecret:k.clientSecret,redirectURL:k.siteUrl+"/kinde-auth/callback",logoutRedirectURL:k.postLogoutRedirectUrl}),U=_({cookie:{name:"kinde_session",httpOnly:!0,path:"/",sameSite:"lax",secrets:[process.env.SESSION_SECRET],secure:"production"===process.env.NODE_ENV}}),E=async(e,t)=>{const r=e.headers.get("Cookie"),s=await U.getSession(r),n={getSessionItem:async e=>s.get(e),setSessionItem:async(e,t)=>s.set(e,t),removeSessionItem:async e=>s.unset(e),destroySession:async()=>(U.destroySession(s),Promise.resolve())};switch(t){case"login":return(async()=>{const t=await A.login(n),{searchParams:r}=new URL(e.url),o=r.get("returnTo");return o&&s.set("post_login_redirect_url",o),h(t.toString(),{headers:{"Set-Cookie":await U.commitSession(s,{maxAge:parseInt(k.cookieMaxAge)||void 0})}})})();case"register":return(async()=>{const t=await A.register(n),{searchParams:r}=new URL(e.url),o=r.get("returnTo");return o&&s.set("post_login_redirect_url",o),h(t.toString(),{headers:{"Set-Cookie":await U.commitSession(s,{maxAge:parseInt(k.cookieMaxAge)||void 0})}})})();case"callback":return(async()=>{await A.handleRedirectToApp(n,new URL(e.url));const t=await n.getSessionItem("post_login_redirect_url");return t&&n.removeSessionItem("post_login_redirect_url"),h((t||k.postLoginRedirectUrl).toString(),{headers:{"Set-Cookie":await U.commitSession(s,{maxAge:parseInt(k.cookieMaxAge)||void 0})}})})();case"logout":return(async()=>{const e=await A.logout(n);return h(e.toString(),{headers:{"Set-Cookie":await U.destroySession(s)}})})()}},R=async e=>{const t=e.headers.get("Cookie"),r=await U.getSession(t),s={getSessionItem:async e=>r.get(e),setSessionItem:async(e,t)=>r.set(e,t),removeSessionItem:async e=>r.unset(e),destroySession:async()=>(U.destroySession(r),Promise.resolve())};return{getClaim:async(e,t)=>{try{return await A.getClaim(s,e,t)}catch(e){return console.error(e),null}},getClaimValue:async(e,t)=>{try{return await A.getClaimValue(s,e,t)}catch(e){return console.error(e),null}},getOrganization:async()=>{try{return await A.getOrganization(s)}catch(e){return console.error(e),null}},getPermission:async e=>{try{return await A.getPermission(s,e)}catch(e){console.error(e)}},getPermissions:async()=>{try{return await A.getPermissions(s)}catch(e){return console.error(e),[]}},getFlag:async(e,t,r)=>{try{return await A.getFlag(s,e.toLowerCase(),t,r)}catch(e){console.error(e)}},getStringFlag:async(e,t)=>{try{return await A.getStringFlag(s,e.toLowerCase(),t)}catch(e){console.error(e)}},getBooleanFlag:async(e,t)=>{try{return await A.getBooleanFlag(s,e.toLowerCase(),t)}catch(e){console.error(e)}},getIntegerFlag:async(e,t)=>{try{return await A.getIntegerFlag(s,e.toLowerCase(),t)}catch(e){console.error(e)}},getToken:async()=>{try{return await A.getToken(s)}catch(e){return console.error(e),null}},getUser:async()=>{try{return await A.getUser(s)}catch(e){return"Cannot get user details, no authentication credential found"!==e.message&&console.error(e),null}},getUserProfile:async()=>{try{return await A.getUserProfile(s)}catch(e){return console.error(e),null}},getUserOrganizations:async()=>{try{return await A.getUserOrganizations(s)}catch(e){return console.error(e),[]}},isAuthenticated:async()=>{try{return await A.isAuthenticated(s)}catch(e){return console.error(e),!1}},refreshTokens:async()=>{try{return await A.refreshTokens(s)}catch(e){console.error(e)}}}},C=async e=>{let t=null;const _=e.headers.get("Cookie"),h=await U.getSession(_),A={getSessionItem:async e=>h.get(e),setSessionItem:async(e,t)=>h.set(e,t),removeSessionItem:async e=>h.unset(e),destroySession:async()=>U.destroySession(h)},E=await A.getSessionItem("kinde_api_access_token");if((e=>{const t=e&&e.access_token||e;if(!t)return!1;const r=I(t,{header:!0}),s=I(t);let n=!0;return k.audience&&(n=s.aud&&s.aud.includes(k.audience)),!!(s.iss==k.issuerURL&&"RS256"==r.alg&&s.exp>Math.floor(Date.now()/1e3)&&n)})(E))t=E;else{const e=await fetch(`${k.issuerUrl}/oauth2/token`,{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:k.clientId||"",client_secret:k.clientSecret||"",audience:k.audience||""})});t=(await e.json()).access_token;try{await A.setSessionItem("kinde_api_access_token",t)}catch(e){console.error(e)}}const R=new r({basePath:k.issuerUrl,accessToken:t,headers:{Accept:"application/json"}});return{usersApi:new s(R),oauthApi:new n(R),subscribersApi:new o(R),organizationsApi:new a(R),connectedAppsApi:new i(R),featureFlagsApi:new c(R),environmentsApi:new l(R),permissionsApi:new u(R),rolesApi:new g(R),businessApi:new d(R),industriesApi:new p(R),timezonesApi:new y(R),applicationsApi:new w(R),callbacksApi:new m(R),apisApi:new S(R)}};export{C as createKindeApiClient,R as getKindeSession,E as handleAuth};
