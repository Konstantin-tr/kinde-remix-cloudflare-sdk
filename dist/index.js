import{createKindeServerClient as e,GrantType as s,Configuration as t,UsersApi as n,OAuthApi as o,SubscribersApi as r,OrganizationsApi as i,ConnectedAppsApi as a,FeatureFlagsApi as c,EnvironmentsApi as l,PermissionsApi as u,RolesApi as d,BusinessApi as g,IndustriesApi as p,TimezonesApi as _,ApplicationsApi as w,CallbacksApi as S,APIsApi as m}from"@kinde-oss/kinde-typescript-sdk";import{createCookieSessionStorage as k,redirect as I}from"@remix-run/node";import{jwtDecode as h}from"jwt-decode";const y={clientId:process.env.KINDE_CLIENT_ID,clientSecret:process.env.KINDE_CLIENT_SECRET,issuerUrl:process.env.KINDE_ISSUER_URL,siteUrl:process.env.KINDE_SITE_URL,postLogoutRedirectUrl:process.env.KINDE_POST_LOGOUT_REDIRECT_URL,postLoginRedirectUrl:process.env.KINDE_POST_LOGIN_REDIRECT_URL,audience:process.env.KINDE_AUDIENCE,cookieMaxAge:process.env.KINDE_COOKIE_MAX_AGE},A=e(s.AUTHORIZATION_CODE,{authDomain:y.issuerUrl,clientId:y.clientId,clientSecret:y.clientSecret,redirectURL:y.siteUrl+"/kinde-auth/callback",logoutRedirectURL:y.postLogoutRedirectUrl}),E=k({cookie:{name:"kinde_session",httpOnly:!0,path:"/",sameSite:"lax",secrets:[process.env.SESSION_SECRET],secure:"production"===process.env.NODE_ENV}}),R=async(e,s)=>{const t=e.headers.get("Cookie"),n=await E.getSession(t),o={getSessionItem:async e=>n.get(e),setSessionItem:async(e,s)=>n.set(e,s),removeSessionItem:async e=>n.unset(e),destroySession:async()=>E.destroySession(n)};switch(s){case"login":return(async()=>{const s=await A.login(o),{searchParams:t}=new URL(e.url),r=t.get("returnTo");return r&&n.set("post_login_redirect_url",r),I(s.toString(),{headers:{"Set-Cookie":await E.commitSession(n,{maxAge:y.cookieMaxAge||void 0})}})})();case"register":return(async()=>{const s=await A.register(o),{searchParams:t}=new URL(e.url),r=t.get("returnTo");return r&&n.set("post_login_redirect_url",r),I(s.toString(),{headers:{"Set-Cookie":await E.commitSession(n,{maxAge:y.cookieMaxAge||void 0})}})})();case"callback":return(async()=>{await A.handleRedirectToApp(o,new URL(e.url));const s=await o.getSessionItem("post_login_redirect_url");return s&&o.removeSessionItem("post_login_redirect_url"),I(s||y.postLoginRedirectUrl,{headers:{"Set-Cookie":await E.commitSession(n,{maxAge:y.cookieMaxAge||void 0})}})})();case"logout":return(async()=>{const e=await A.logout(o);return I(e.toString(),{headers:{"Set-Cookie":await E.destroySession(n)}})})()}},v={s:"string",i:"integer",b:"boolean"},T=async e=>{const s=e.headers.get("Cookie"),t=await E.getSession(s),n=t.get("user")||null,o=t.get("id_token")||null;let r;try{r=h(o)}catch(e){}const i=t.get("access_token")||null;let a;try{a=h(i)}catch(e){}const c=(e,s="accessToken")=>r||a?"accessToken"===s?a[e]:"idToken"===s?r[e]:null:null,l=c("permissions")||[],u=c("org_codes","idToken"),d=c("org_code"),g=(e,s,t)=>{const n=c("feature_flags"),o=n&&n[e]?n[e]:{};if(o=={}&&null==s)throw Error(`Flag ${e} was not found, and no default value has been provided`);if(t&&o.t&&t!==o.t)throw Error(`Flag ${e} is of type ${v[o.t]} - requested type ${v[t]}`);return{code:e,type:v[o.t||t],value:null==o.v?s:o.v,is_default:null==o.v,defaultValue:s}};return{user:n,idToken:r,accessToken:a,idTokenRaw:o,accessTokenRaw:i,permissions:l,userOrganizations:u,organization:d,getPermission:e=>l&&l.includes(e)?{isGranted:!0,orgCode:d}:null,getFlag:g,getStringFlag:(e,s)=>{try{return g(e,s,"b").value}catch(e){console.error(e)}},getBooleanFlag:(e,s)=>{try{return g(e,s,"b").value}catch(e){console.error(e)}},getIntegerFlag:(e,s)=>{try{return g(e,s,"i").value}catch(e){console.error(e)}}}},U=async e=>{let s=null;const k=e.headers.get("Cookie"),I=await E.getSession(k),A={getSessionItem:async e=>I.get(e),setSessionItem:async(e,s)=>I.set(e,s),removeSessionItem:async e=>I.unset(e),destroySession:async()=>E.destroySession(I)},R=await A.getSessionItem("kinde_api_access_token");if((e=>{const s=e&&e.access_token||e;if(!s)return!1;const t=h(s,{header:!0}),n=h(s);let o=!0;return y.audience&&(o=n.aud&&n.aud.includes(y.audience)),!!(n.iss==y.issuerURL&&"RS256"==t.alg&&n.exp>Math.floor(Date.now()/1e3)&&o)})(R))s=R;else{const e=await fetch(`${y.issuerUrl}/oauth2/token`,{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:y.clientId||"",client_secret:y.clientSecret||"",audience:y.audience||""})});s=(await e.json()).access_token;try{await A.setSessionItem("kinde_api_access_token",s)}catch(e){console.error(e)}}const v=new t({basePath:y.issuerUrl,accessToken:s,headers:{Accept:"application/json"}});return{usersApi:new n(v),oauthApi:new o(v),subscribersApi:new r(v),organizationsApi:new i(v),connectedAppsApi:new a(v),featureFlagsApi:new c(v),environmentsApi:new l(v),permissionsApi:new u(v),rolesApi:new d(v),businessApi:new g(v),industriesApi:new p(v),timezonesApi:new _(v),applicationsApi:new w(v),callbacksApi:new S(v),apisApi:new m(v)}};export{U as createKindeApiClient,T as getKindeSession,R as handleAuth};
