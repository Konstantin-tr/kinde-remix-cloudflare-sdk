import{createKindeServerClient as e,GrantType as s,Configuration as t,UsersApi as n,OAuthApi as o,SubscribersApi as i,OrganizationsApi as r,ConnectedAppsApi as a,FeatureFlagsApi as c,EnvironmentsApi as l,PermissionsApi as u,RolesApi as d,BusinessApi as p,IndustriesApi as g,TimezonesApi as S,ApplicationsApi as w,CallbacksApi as _,APIsApi as m}from"@kinde-oss/kinde-typescript-sdk";import{createCookieSessionStorage as k,redirect as y}from"@remix-run/node";import{jwtDecode as h}from"jwt-decode";const I={clientId:process.env.KINDE_CLIENT_ID,clientSecret:process.env.KINDE_CLIENT_SECRET,issuerUrl:process.env.KINDE_ISSUER_URL,siteUrl:process.env.KINDE_SITE_URL,postLogoutRedirectUrl:process.env.KINDE_POST_LOGOUT_REDIRECT_URL,postLoginRedirectUrl:process.env.KINDE_POST_LOGIN_REDIRECT_URL,audience:process.env.KINDE_AUDIENCE},E=e(s.AUTHORIZATION_CODE,{authDomain:I.issuerUrl,clientId:I.clientId,clientSecret:I.clientSecret,redirectURL:I.siteUrl+"/kinde-auth/callback",logoutRedirectURL:I.postLogoutRedirectUrl}),R=k({cookie:{name:"kinde_session",httpOnly:!0,path:"/",sameSite:"lax",secrets:[process.env.SESSION_SECRET],secure:"production"===process.env.NODE_ENV}}),A=async(e,s)=>{const t=e.headers.get("Cookie"),n=await R.getSession(t),o={getSessionItem:async e=>n.get(e),setSessionItem:async(e,s)=>n.set(e,s),removeSessionItem:async e=>n.unset(e),destroySession:async()=>R.destroySession(n)};switch(s){case"login":return(async()=>{const e=await E.login(o);return y(e.toString(),{headers:{"Set-Cookie":await R.commitSession(n,{maxAge:604800})}})})();case"register":return(async()=>{const e=await E.register(o);return y(e.toString(),{headers:{"Set-Cookie":await R.commitSession(n,{maxAge:604800})}})})();case"callback":return(async()=>(await E.handleRedirectToApp(o,new URL(e.url)),y("/",{headers:{"Set-Cookie":await R.commitSession(n,{maxAge:604800})}})))();case"logout":return(async()=>{const e=await E.logout(o);return y(e.toString(),{headers:{"Set-Cookie":await R.destroySession(n)}})})()}},T={s:"string",i:"integer",b:"boolean"},U=async e=>{const s=e.headers.get("Cookie"),t=await R.getSession(s),n=t.get("user")||null,o=t.get("id_token")||null;let i;try{i=h(o)}catch(e){}const r=t.get("access_token")||null;let a;try{a=h(r)}catch(e){}const c=(e,s="accessToken")=>i||a?"accessToken"===s?a[e]:"idToken"===s?i[e]:null:null,l=c("permissions"),u=c("org_codes","idToken"),d=c("org_code"),p=(e,s,t)=>{const n=c("feature_flags"),o=n&&n[e]?n[e]:{};if(o=={}&&null==s)throw Error(`Flag ${e} was not found, and no default value has been provided`);if(t&&o.t&&t!==o.t)throw Error(`Flag ${e} is of type ${T[o.t]} - requested type ${T[t]}`);return{code:e,type:T[o.t||t],value:null==o.v?s:o.v,is_default:null==o.v,defaultValue:s}};return{user:n,idToken:i,accessToken:a,idTokenRaw:o,accessTokenRaw:r,permissions:l,userOrganizations:u,organization:d,getPermission:e=>l.includes(e)?{isGranted:!0,orgCode:d}:null,getFlag:p,getStringFlag:(e,s)=>{try{return p(e,s,"b").value}catch(e){console.error(e)}},getBooleanFlag:(e,s)=>{try{return p(e,s,"b").value}catch(e){console.error(e)}},getIntegerFlag:(e,s)=>{try{return p(e,s,"i").value}catch(e){console.error(e)}}}},v=async e=>{let s=null;const k=e.headers.get("Cookie"),y=await R.getSession(k),E={getSessionItem:async e=>y.get(e),setSessionItem:async(e,s)=>y.set(e,s),removeSessionItem:async e=>y.unset(e),destroySession:async()=>R.destroySession(y)},A=await E.getSessionItem("kinde_api_access_token");if((e=>{const s=e&&e.access_token||e;if(!s)return!1;const t=h(s,{header:!0}),n=h(s);let o=!0;return I.audience&&(o=n.aud&&n.aud.includes(I.audience)),!!(n.iss==I.issuerURL&&"RS256"==t.alg&&n.exp>Math.floor(Date.now()/1e3)&&o)})(A))s=A;else{const e=await fetch(`${I.issuerUrl}/oauth2/token`,{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:I.clientId||"",client_secret:I.clientSecret||"",audience:I.audience||""})});s=(await e.json()).access_token;try{await E.setSessionItem("kinde_api_access_token",s)}catch(e){console.error(e)}}const T=new t({basePath:I.issuerUrl,accessToken:s,headers:{Accept:"application/json"}});return{usersApi:new n(T),oauthApi:new o(T),subscribersApi:new i(T),organizationsApi:new r(T),connectedAppsApi:new a(T),featureFlagsApi:new c(T),environmentsApi:new l(T),permissionsApi:new u(T),rolesApi:new d(T),businessApi:new p(T),industriesApi:new g(T),timezonesApi:new S(T),applicationsApi:new w(T),callbacksApi:new _(T),apisApi:new m(T)}};export{v as createKindeApiClient,U as getKindeSession,A as handleAuth};
