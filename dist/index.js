import{createKindeServerClient as e,GrantType as s,Configuration as t,UsersApi as n,OAuthApi as o,SubscribersApi as r,OrganizationsApi as i,ConnectedAppsApi as a,FeatureFlagsApi as c,EnvironmentsApi as l,PermissionsApi as g,RolesApi as u,BusinessApi as d,IndustriesApi as p,TimezonesApi as w,ApplicationsApi as S,CallbacksApi as _,APIsApi as m}from"@kinde-oss/kinde-typescript-sdk";import{createCookieSessionStorage as y,redirect as I}from"@remix-run/node";import{jwtDecode as k}from"jwt-decode";const h={clientId:process.env.KINDE_CLIENT_ID,clientSecret:process.env.KINDE_CLIENT_SECRET,issuerUrl:process.env.KINDE_ISSUER_URL,siteUrl:process.env.KINDE_SITE_URL,postLogoutRedirectUrl:process.env.KINDE_POST_LOGOUT_REDIRECT_URL,postLoginRedirectUrl:process.env.KINDE_POST_LOGIN_REDIRECT_URL,audience:process.env.KINDE_AUDIENCE,cookieMaxAge:process.env.KINDE_COOKIE_MAX_AGE},A=e(s.AUTHORIZATION_CODE,{authDomain:h.issuerUrl,clientId:h.clientId,clientSecret:h.clientSecret,redirectURL:h.siteUrl+"/kinde-auth/callback",logoutRedirectURL:h.postLogoutRedirectUrl}),E=y({cookie:{name:"kinde_session",httpOnly:!0,path:"/",sameSite:"lax",secrets:[process.env.SESSION_SECRET],secure:"production"===process.env.NODE_ENV}}),R=async(e,s)=>{const t=e.headers.get("Cookie"),n=await E.getSession(t),o={getSessionItem:async e=>n.get(e),setSessionItem:async(e,s)=>n.set(e,s),removeSessionItem:async e=>n.unset(e),destroySession:async()=>E.destroySession(n)};switch(s){case"login":return(async()=>{const s=await A.login(o),{searchParams:t}=new URL(e.url),r=t.get("returnTo");return r&&n.set("post_login_redirect_url",r),I(s.toString(),{headers:{"Set-Cookie":await E.commitSession(n,{maxAge:h.cookieMaxAge||void 0})}})})();case"register":return(async()=>{const s=await A.register(o),{searchParams:t}=new URL(e.url),r=t.get("returnTo");return r&&n.set("post_login_redirect_url",r),I(s.toString(),{headers:{"Set-Cookie":await E.commitSession(n,{maxAge:h.cookieMaxAge||void 0})}})})();case"callback":return(async()=>{await A.handleRedirectToApp(o,new URL(e.url));const s=await o.getSessionItem("post_login_redirect_url");return s&&o.removeSessionItem("post_login_redirect_url"),I(s||h.postLoginRedirectUrl,{headers:{"Set-Cookie":await E.commitSession(n,{maxAge:h.cookieMaxAge||void 0})}})})();case"logout":return(async()=>{const e=await A.logout(o);return I(e.toString(),{headers:{"Set-Cookie":await E.destroySession(n)}})})()}},U=async e=>{const s=e.headers.get("Cookie"),t=await E.getSession(s),n={getSessionItem:async e=>t.get(e),setSessionItem:async(e,s)=>t.set(e,s),removeSessionItem:async e=>t.unset(e),destroySession:async()=>E.destroySession(t)},o=t.get("user")||null,r=t.get("id_token")||null;let i;try{i=k(r)}catch(e){}const a=t.get("access_token")||null;let c;try{c=k(a)}catch(e){}const l=(e,s="accessToken")=>i||c?"accessToken"===s?c[e]:"idToken"===s?i[e]:null:null,g=l("permissions")||[],u=l("org_codes","idToken"),d=l("org_code");return{user:o,idToken:i,accessToken:c,idTokenRaw:r,accessTokenRaw:a,permissions:g,userOrganizations:u,organization:d,getPermission:async e=>{try{return await A.getPermission(n,e)}catch(e){console.error(e)}},getFlag:async(e,s,t)=>{try{return await A.getFlag(n,e.toLowerCase(),s,t)}catch(e){console.error(e)}},getStringFlag:async(e,s)=>{try{return await A.getStringFlag(n,e.toLowerCase(),s)}catch(e){console.error(e)}},getBooleanFlag:async(e,s)=>{try{return await A.getBooleanFlag(n,e.toLowerCase(),s)}catch(e){console.error(e)}},getIntegerFlag:async(e,s)=>{try{return await A.getIntegerFlag(n,e.toLowerCase(),s)}catch(e){console.error(e)}},getUser:async()=>{try{return await A.getUser(n)}catch(e){return"Cannot get user details, no authentication credential found"!==e.message&&console.error(e),null}}}},T=async e=>{let s=null;const y=e.headers.get("Cookie"),I=await E.getSession(y),A={getSessionItem:async e=>I.get(e),setSessionItem:async(e,s)=>I.set(e,s),removeSessionItem:async e=>I.unset(e),destroySession:async()=>E.destroySession(I)},R=await A.getSessionItem("kinde_api_access_token");if((e=>{const s=e&&e.access_token||e;if(!s)return!1;const t=k(s,{header:!0}),n=k(s);let o=!0;return h.audience&&(o=n.aud&&n.aud.includes(h.audience)),!!(n.iss==h.issuerURL&&"RS256"==t.alg&&n.exp>Math.floor(Date.now()/1e3)&&o)})(R))s=R;else{const e=await fetch(`${h.issuerUrl}/oauth2/token`,{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:h.clientId||"",client_secret:h.clientSecret||"",audience:h.audience||""})});s=(await e.json()).access_token;try{await A.setSessionItem("kinde_api_access_token",s)}catch(e){console.error(e)}}const U=new t({basePath:h.issuerUrl,accessToken:s,headers:{Accept:"application/json"}});return{usersApi:new n(U),oauthApi:new o(U),subscribersApi:new r(U),organizationsApi:new i(U),connectedAppsApi:new a(U),featureFlagsApi:new c(U),environmentsApi:new l(U),permissionsApi:new g(U),rolesApi:new u(U),businessApi:new d(U),industriesApi:new p(U),timezonesApi:new w(U),applicationsApi:new S(U),callbacksApi:new _(U),apisApi:new m(U)}};export{T as createKindeApiClient,U as getKindeSession,R as handleAuth};
