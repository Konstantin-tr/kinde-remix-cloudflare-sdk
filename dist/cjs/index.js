"use strict";var e=require("@kinde-oss/kinde-typescript-sdk"),s=require("@remix-run/node"),t=require("jwt-decode");const n={clientId:process.env.KINDE_CLIENT_ID,clientSecret:process.env.KINDE_CLIENT_SECRET,issuerUrl:process.env.KINDE_ISSUER_URL,siteUrl:process.env.KINDE_SITE_URL,postLogoutRedirectUrl:process.env.KINDE_POST_LOGOUT_REDIRECT_URL,postLoginRedirectUrl:process.env.KINDE_POST_LOGIN_REDIRECT_URL,audience:process.env.KINDE_AUDIENCE,cookieMaxAge:process.env.KINDE_COOKIE_MAX_AGE},i=e.createKindeServerClient(e.GrantType.AUTHORIZATION_CODE,{authDomain:n.issuerUrl,clientId:n.clientId,clientSecret:n.clientSecret,redirectURL:n.siteUrl+"/kinde-auth/callback",logoutRedirectURL:n.postLogoutRedirectUrl}),o=s.createCookieSessionStorage({cookie:{name:"kinde_session",httpOnly:!0,path:"/",sameSite:"lax",secrets:[process.env.SESSION_SECRET],secure:"production"===process.env.NODE_ENV}}),r={s:"string",i:"integer",b:"boolean"};exports.createKindeApiClient=async s=>{let i=null;const r=s.headers.get("Cookie"),a=await o.getSession(r),c={getSessionItem:async e=>a.get(e),setSessionItem:async(e,s)=>a.set(e,s),removeSessionItem:async e=>a.unset(e),destroySession:async()=>o.destroySession(a)},l=await c.getSessionItem("kinde_api_access_token");if((e=>{const s=e&&e.access_token||e;if(!s)return!1;const i=t.jwtDecode(s,{header:!0}),o=t.jwtDecode(s);let r=!0;return n.audience&&(r=o.aud&&o.aud.includes(n.audience)),!!(o.iss==n.issuerURL&&"RS256"==i.alg&&o.exp>Math.floor(Date.now()/1e3)&&r)})(l))i=l;else{const e=await fetch(`${n.issuerUrl}/oauth2/token`,{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:n.clientId||"",client_secret:n.clientSecret||"",audience:n.audience||""})});i=(await e.json()).access_token;try{await c.setSessionItem("kinde_api_access_token",i)}catch(e){console.error(e)}}const u=new e.Configuration({basePath:n.issuerUrl,accessToken:i,headers:{Accept:"application/json"}});return{usersApi:new e.UsersApi(u),oauthApi:new e.OAuthApi(u),subscribersApi:new e.SubscribersApi(u),organizationsApi:new e.OrganizationsApi(u),connectedAppsApi:new e.ConnectedAppsApi(u),featureFlagsApi:new e.FeatureFlagsApi(u),environmentsApi:new e.EnvironmentsApi(u),permissionsApi:new e.PermissionsApi(u),rolesApi:new e.RolesApi(u),businessApi:new e.BusinessApi(u),industriesApi:new e.IndustriesApi(u),timezonesApi:new e.TimezonesApi(u),applicationsApi:new e.ApplicationsApi(u),callbacksApi:new e.CallbacksApi(u),apisApi:new e.APIsApi(u)}},exports.getKindeSession=async e=>{const s=e.headers.get("Cookie"),n=await o.getSession(s),i=n.get("user")||null,a=n.get("id_token")||null;let c;try{c=t.jwtDecode(a)}catch(e){}const l=n.get("access_token")||null;let u;try{u=t.jwtDecode(l)}catch(e){}const d=(e,s="accessToken")=>c||u?"accessToken"===s?u[e]:"idToken"===s?c[e]:null:null,p=d("permissions")||[],g=d("org_codes","idToken"),_=d("org_code"),S=(e,s,t)=>{const n=d("feature_flags"),i=n&&n[e]?n[e]:{};if(i=={}&&null==s)throw Error(`Flag ${e} was not found, and no default value has been provided`);if(t&&i.t&&t!==i.t)throw Error(`Flag ${e} is of type ${r[i.t]} - requested type ${r[t]}`);return{code:e,type:r[i.t||t],value:null==i.v?s:i.v,is_default:null==i.v,defaultValue:s}};return{user:i,idToken:c,accessToken:u,idTokenRaw:a,accessTokenRaw:l,permissions:p,userOrganizations:g,organization:_,getPermission:e=>p&&p.includes(e)?{isGranted:!0,orgCode:_}:null,getFlag:S,getStringFlag:(e,s)=>{try{return S(e,s,"b").value}catch(e){console.error(e)}},getBooleanFlag:(e,s)=>{try{return S(e,s,"b").value}catch(e){console.error(e)}},getIntegerFlag:(e,s)=>{try{return S(e,s,"i").value}catch(e){console.error(e)}}}},exports.handleAuth=async(e,t)=>{const r=e.headers.get("Cookie"),a=await o.getSession(r),c={getSessionItem:async e=>a.get(e),setSessionItem:async(e,s)=>a.set(e,s),removeSessionItem:async e=>a.unset(e),destroySession:async()=>o.destroySession(a)};switch(t){case"login":return(async()=>{const t=await i.login(c),{searchParams:r}=new URL(e.url),l=r.get("returnTo");return l&&a.set("post_login_redirect_url",l),s.redirect(t.toString(),{headers:{"Set-Cookie":await o.commitSession(a,{maxAge:n.cookieMaxAge||void 0})}})})();case"register":return(async()=>{const t=await i.register(c),{searchParams:r}=new URL(e.url),l=r.get("returnTo");return l&&a.set("post_login_redirect_url",l),s.redirect(t.toString(),{headers:{"Set-Cookie":await o.commitSession(a,{maxAge:n.cookieMaxAge||void 0})}})})();case"callback":return(async()=>{await i.handleRedirectToApp(c,new URL(e.url));const t=await c.getSessionItem("post_login_redirect_url");t&&c.removeSessionItem("post_login_redirect_url");const r=t||n.postLoginRedirectUrl;return s.redirect(r,{headers:{"Set-Cookie":await o.commitSession(a,{maxAge:n.cookieMaxAge||void 0})}})})();case"logout":return(async()=>{const e=await i.logout(c);return s.redirect(e.toString(),{headers:{"Set-Cookie":await o.destroySession(a)}})})()}};
