"use strict";var e=require("@kinde-oss/kinde-typescript-sdk"),s=require("@remix-run/node"),t=require("jwt-decode");const n={clientId:process.env.KINDE_CLIENT_ID,clientSecret:process.env.KINDE_CLIENT_SECRET,issuerUrl:process.env.KINDE_ISSUER_URL,siteUrl:process.env.KINDE_SITE_URL,postLogoutRedirectUrl:process.env.KINDE_POST_LOGOUT_REDIRECT_URL,postLoginRedirectUrl:process.env.KINDE_POST_LOGIN_REDIRECT_URL,audience:process.env.KINDE_AUDIENCE,cookieMaxAge:process.env.KINDE_COOKIE_MAX_AGE},o=e.createKindeServerClient(e.GrantType.AUTHORIZATION_CODE,{authDomain:n.issuerUrl,clientId:n.clientId,clientSecret:n.clientSecret,redirectURL:n.siteUrl+"/kinde-auth/callback",logoutRedirectURL:n.postLogoutRedirectUrl}),r=s.createCookieSessionStorage({cookie:{name:"kinde_session",httpOnly:!0,path:"/",sameSite:"lax",secrets:[process.env.SESSION_SECRET],secure:"production"===process.env.NODE_ENV}});exports.createKindeApiClient=async s=>{let o=null;const i=s.headers.get("Cookie"),a=await r.getSession(i),c={getSessionItem:async e=>a.get(e),setSessionItem:async(e,s)=>a.set(e,s),removeSessionItem:async e=>a.unset(e),destroySession:async()=>r.destroySession(a)},l=await c.getSessionItem("kinde_api_access_token");if((e=>{const s=e&&e.access_token||e;if(!s)return!1;const o=t.jwtDecode(s,{header:!0}),r=t.jwtDecode(s);let i=!0;return n.audience&&(i=r.aud&&r.aud.includes(n.audience)),!!(r.iss==n.issuerURL&&"RS256"==o.alg&&r.exp>Math.floor(Date.now()/1e3)&&i)})(l))o=l;else{const e=await fetch(`${n.issuerUrl}/oauth2/token`,{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:n.clientId||"",client_secret:n.clientSecret||"",audience:n.audience||""})});o=(await e.json()).access_token;try{await c.setSessionItem("kinde_api_access_token",o)}catch(e){console.error(e)}}const d=new e.Configuration({basePath:n.issuerUrl,accessToken:o,headers:{Accept:"application/json"}});return{usersApi:new e.UsersApi(d),oauthApi:new e.OAuthApi(d),subscribersApi:new e.SubscribersApi(d),organizationsApi:new e.OrganizationsApi(d),connectedAppsApi:new e.ConnectedAppsApi(d),featureFlagsApi:new e.FeatureFlagsApi(d),environmentsApi:new e.EnvironmentsApi(d),permissionsApi:new e.PermissionsApi(d),rolesApi:new e.RolesApi(d),businessApi:new e.BusinessApi(d),industriesApi:new e.IndustriesApi(d),timezonesApi:new e.TimezonesApi(d),applicationsApi:new e.ApplicationsApi(d),callbacksApi:new e.CallbacksApi(d),apisApi:new e.APIsApi(d)}},exports.getKindeSession=async e=>{const s=e.headers.get("Cookie"),n=await r.getSession(s),i={getSessionItem:async e=>n.get(e),setSessionItem:async(e,s)=>n.set(e,s),removeSessionItem:async e=>n.unset(e),destroySession:async()=>r.destroySession(n)},a=n.get("user")||null,c=n.get("id_token")||null;let l;try{l=t.jwtDecode(c)}catch(e){}const d=n.get("access_token")||null;let u;try{u=t.jwtDecode(d)}catch(e){}const g=(e,s="accessToken")=>l||u?"accessToken"===s?u[e]:"idToken"===s?l[e]:null:null,p=g("permissions")||[],w=g("org_codes","idToken"),S=g("org_code");return{user:a,idToken:l,accessToken:u,idTokenRaw:c,accessTokenRaw:d,permissions:p,userOrganizations:w,organization:S,getPermission:async e=>{try{return await o.getPermission(i,e)}catch(e){console.error(e)}},getFlag:async(e,s,t)=>{try{return await o.getFlag(i,e.toLowerCase(),s,t)}catch(e){console.error(e)}},getStringFlag:async(e,s)=>{try{return await o.getStringFlag(i,e.toLowerCase(),s)}catch(e){console.error(e)}},getBooleanFlag:async(e,s)=>{try{return await o.getBooleanFlag(i,e.toLowerCase(),s)}catch(e){console.error(e)}},getIntegerFlag:async(e,s)=>{try{return await o.getIntegerFlag(i,e.toLowerCase(),s)}catch(e){console.error(e)}},getUser:async()=>{try{return await o.getUser(i)}catch(e){return"Cannot get user details, no authentication credential found"!==e.message&&console.error(e),null}}}},exports.handleAuth=async(e,t)=>{const i=e.headers.get("Cookie"),a=await r.getSession(i),c={getSessionItem:async e=>a.get(e),setSessionItem:async(e,s)=>a.set(e,s),removeSessionItem:async e=>a.unset(e),destroySession:async()=>r.destroySession(a)};switch(t){case"login":return(async()=>{const t=await o.login(c),{searchParams:i}=new URL(e.url),l=i.get("returnTo");return l&&a.set("post_login_redirect_url",l),s.redirect(t.toString(),{headers:{"Set-Cookie":await r.commitSession(a,{maxAge:n.cookieMaxAge||void 0})}})})();case"register":return(async()=>{const t=await o.register(c),{searchParams:i}=new URL(e.url),l=i.get("returnTo");return l&&a.set("post_login_redirect_url",l),s.redirect(t.toString(),{headers:{"Set-Cookie":await r.commitSession(a,{maxAge:n.cookieMaxAge||void 0})}})})();case"callback":return(async()=>{await o.handleRedirectToApp(c,new URL(e.url));const t=await c.getSessionItem("post_login_redirect_url");t&&c.removeSessionItem("post_login_redirect_url");const i=t||n.postLoginRedirectUrl;return s.redirect(i,{headers:{"Set-Cookie":await r.commitSession(a,{maxAge:n.cookieMaxAge||void 0})}})})();case"logout":return(async()=>{const e=await o.logout(c);return s.redirect(e.toString(),{headers:{"Set-Cookie":await r.destroySession(a)}})})()}};
