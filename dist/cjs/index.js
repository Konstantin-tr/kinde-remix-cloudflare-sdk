"use strict";var e=require("@kinde-oss/kinde-typescript-sdk"),t=require("@remix-run/node"),r=require("jwt-decode");const s={clientId:process.env.KINDE_CLIENT_ID,clientSecret:process.env.KINDE_CLIENT_SECRET,issuerUrl:process.env.KINDE_ISSUER_URL,siteUrl:process.env.KINDE_SITE_URL,postLogoutRedirectUrl:process.env.KINDE_POST_LOGOUT_REDIRECT_URL,postLoginRedirectUrl:process.env.KINDE_POST_LOGIN_REDIRECT_URL,audience:process.env.KINDE_AUDIENCE,cookieMaxAge:process.env.KINDE_COOKIE_MAX_AGE},n=e.createKindeServerClient(e.GrantType.AUTHORIZATION_CODE,{authDomain:s.issuerUrl,clientId:s.clientId,clientSecret:s.clientSecret,redirectURL:s.siteUrl+"/kinde-auth/callback",logoutRedirectURL:s.postLogoutRedirectUrl}),o=t.createCookieSessionStorage({cookie:{name:"kinde_session",httpOnly:!0,path:"/",sameSite:"lax",secrets:[process.env.SESSION_SECRET],secure:"production"===process.env.NODE_ENV}});exports.createKindeApiClient=async t=>{let n=null;const i=t.headers.get("Cookie"),a=await o.getSession(i),c={getSessionItem:async e=>a.get(e),setSessionItem:async(e,t)=>a.set(e,t),removeSessionItem:async e=>a.unset(e),destroySession:async()=>o.destroySession(a)},l=await c.getSessionItem("kinde_api_access_token");if((e=>{const t=e&&e.access_token||e;if(!t)return!1;const n=r.jwtDecode(t,{header:!0}),o=r.jwtDecode(t);let i=!0;return s.audience&&(i=o.aud&&o.aud.includes(s.audience)),!!(o.iss==s.issuerURL&&"RS256"==n.alg&&o.exp>Math.floor(Date.now()/1e3)&&i)})(l))n=l;else{const e=await fetch(`${s.issuerUrl}/oauth2/token`,{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:s.clientId||"",client_secret:s.clientSecret||"",audience:s.audience||""})});n=(await e.json()).access_token;try{await c.setSessionItem("kinde_api_access_token",n)}catch(e){console.error(e)}}const u=new e.Configuration({basePath:s.issuerUrl,accessToken:n,headers:{Accept:"application/json"}});return{usersApi:new e.UsersApi(u),oauthApi:new e.OAuthApi(u),subscribersApi:new e.SubscribersApi(u),organizationsApi:new e.OrganizationsApi(u),connectedAppsApi:new e.ConnectedAppsApi(u),featureFlagsApi:new e.FeatureFlagsApi(u),environmentsApi:new e.EnvironmentsApi(u),permissionsApi:new e.PermissionsApi(u),rolesApi:new e.RolesApi(u),businessApi:new e.BusinessApi(u),industriesApi:new e.IndustriesApi(u),timezonesApi:new e.TimezonesApi(u),applicationsApi:new e.ApplicationsApi(u),callbacksApi:new e.CallbacksApi(u),apisApi:new e.APIsApi(u)}},exports.getKindeSession=async e=>{const t=e.headers.get("Cookie"),r=await o.getSession(t),s={getSessionItem:async e=>r.get(e),setSessionItem:async(e,t)=>r.set(e,t),removeSessionItem:async e=>r.unset(e),destroySession:async()=>(o.destroySession(r),Promise.resolve())};return{getClaim:async(e,t)=>{try{return await n.getClaim(s,e,t)}catch(e){return console.error(e),null}},getClaimValue:async(e,t)=>{try{return await n.getClaimValue(s,e,t)}catch(e){return console.error(e),null}},getOrganization:async()=>{try{return await n.getOrganization(s)}catch(e){return console.error(e),null}},getPermission:async e=>{try{return await n.getPermission(s,e)}catch(e){console.error(e)}},getPermissions:async()=>{try{return await n.getPermissions(s)}catch(e){return console.error(e),[]}},getFlag:async(e,t,r)=>{try{return await n.getFlag(s,e.toLowerCase(),t,r)}catch(e){console.error(e)}},getStringFlag:async(e,t)=>{try{return await n.getStringFlag(s,e.toLowerCase(),t)}catch(e){console.error(e)}},getBooleanFlag:async(e,t)=>{try{return await n.getBooleanFlag(s,e.toLowerCase(),t)}catch(e){console.error(e)}},getIntegerFlag:async(e,t)=>{try{return await n.getIntegerFlag(s,e.toLowerCase(),t)}catch(e){console.error(e)}},getToken:async()=>{try{return await n.getToken(s)}catch(e){return console.error(e),null}},getUser:async()=>{try{return await n.getUser(s)}catch(e){return"Cannot get user details, no authentication credential found"!==e.message&&console.error(e),null}},getUserProfile:async()=>{try{return await n.getUserProfile(s)}catch(e){return console.error(e),null}},getUserOrganizations:async()=>{try{return await n.getUserOrganizations(s)}catch(e){return console.error(e),[]}},isAuthenticated:async()=>{try{return await n.isAuthenticated(s)}catch(e){return console.error(e),!1}},refreshTokens:async()=>{try{return await n.refreshTokens(s)}catch(e){console.error(e)}}}},exports.handleAuth=async(e,r)=>{const i=e.headers.get("Cookie"),a=await o.getSession(i),c={getSessionItem:async e=>a.get(e),setSessionItem:async(e,t)=>a.set(e,t),removeSessionItem:async e=>a.unset(e),destroySession:async()=>(o.destroySession(a),Promise.resolve())};switch(r){case"login":return(async()=>{const r=await n.login(c),{searchParams:i}=new URL(e.url),l=i.get("returnTo");return l&&a.set("post_login_redirect_url",l),t.redirect(r.toString(),{headers:{"Set-Cookie":await o.commitSession(a,{maxAge:parseInt(s.cookieMaxAge)||void 0})}})})();case"register":return(async()=>{const r=await n.register(c),{searchParams:i}=new URL(e.url),l=i.get("returnTo");return l&&a.set("post_login_redirect_url",l),t.redirect(r.toString(),{headers:{"Set-Cookie":await o.commitSession(a,{maxAge:parseInt(s.cookieMaxAge)||void 0})}})})();case"callback":return(async()=>{await n.handleRedirectToApp(c,new URL(e.url));const r=await c.getSessionItem("post_login_redirect_url");r&&c.removeSessionItem("post_login_redirect_url");const i=r||s.postLoginRedirectUrl;return t.redirect(i.toString(),{headers:{"Set-Cookie":await o.commitSession(a,{maxAge:parseInt(s.cookieMaxAge)||void 0})}})})();case"logout":return(async()=>{const e=await n.logout(c);return t.redirect(e.toString(),{headers:{"Set-Cookie":await o.destroySession(a)}})})()}};
